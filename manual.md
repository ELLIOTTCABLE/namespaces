# Namespaces

<br>

- [Building libraries](#Libraries)
  - [OASIS status](#LibrariesOASIS)
- [Generated files](#Generated)



<br>

<a id="Libraries"></a>
## Building libraries

To build one or more libraries with Namespaces, tag your library directories
with `namespace_lib` like this:

```
src/                            [no tags]
|-- lib_1/                      namespace, namespace_lib
|   |-- namespace/              namespace
|   |   |-- foo.ml
|   |   +-- bar.ml
|   |
|   +-- other_namespace/        namespace
|       +-- foo.ml
|
+-- lib_2/                      namespace, namespace_lib
    +-- namespace/              namespace
        |-- foo.ml
        +-- bar.ml
```

This causes Namespaces to generate the requisite `.mllib` files for Ocamlbuild.
Then, you can build the targets `lib_1.cma`, `lib_1.cmxa`, `lib_2.cma`,
`lib_2.cmxa`.

To install with Findlib, describe the libraries as normal in `META`. The easiest
way to list the files to install is to list the libraries, and then find all
`.cmi`, `.cmt`, and `.cmti` files. For example, in `Makefile` syntax:

```
TO_INSTALL :=                         \
    _build/src/lib_1.cma              \
    _build/src/lib_1.cmxa             \
    _build/src/lib_1.a                \
    _build/src/lib_2.cma              \
    _build/src/lib_2.cmxa             \
    _build/src/lib_2.a                \
    $(shell find _build -name *.cmi)  \
    $(shell find _build -name *.cmt)  \
    $(shell find _build -name *.cmti)

install :
    ocamlfind install $(PACKAGE) META $(TO_INSTALL)
```

See the [library test][libtest] for a working example.

[libtest]: https://github.com/aantron/namespaces/tree/master/test/3-library

<a id="LibrariesOASIS"></a>
#### OASIS status

Building libraries (as opposed to executables) with OASIS is, unfortunately,
currently not supported. It *almost* works, but there is a conflict between
Namespaces' handling of libraries and that of OASIS. In particular, OASIS
overwrites the `.mllib` file that is generated by Namespaces. As a result, the
installed library is broken. You could manually enter the contents of
Namespaces' generated `.mllib` in the `Modules:` key in `_oasis`, but this is
clearly not maintainable.

The closest approach, up to now, is to tag directories as described above, then
create a `META` file that looks like this:

```
OASISFormat: 0.4
Name:        my_lib
Version:     0.1
Synopsis:    Description
Authors:     Me
License:     BSD-2-clause
BuildTools:  ocamlbuild
Plugins:     META (0.3)

OCamlVersion:           >= 4.02
AlphaFeatures:          ocamlbuild_more_args
XOCamlbuildPluginTags:  package(namespaces)

Library lib_1
  FindlibName:      my_lib
  Path:             src
  Modules:          Lib_1
  XMETADescription: lib_1

Library lib_2
  FindlibParent:    lib_1
  Path:             src
  Modules:          Lib_2
  XMETADescription: lib_2
```

Instead of installing using OASIS, you should install as in the Ocamlbuild
instructions above.

See the [OASIS library test][oasis-libtest] for an example.

[oasis-libtest]: https://github.com/aantron/namespaces/tree/master/test/4-oasis-library



<br>

<a id="Generated"></a>
## Generated files

Namespaces has trouble with generated files, such as `.ml` files generated from
`.mll` files by `ocamllex`. If you have such files in your project, you need to
tell Namespaces about the generator. For example, if you have a program that
generates `.ml` and `.mli` files from `.rpc` files,

    let () =
        Ocamlbuild_plugin.dispatch
            (Namespaces.handler ~generators:["%.rpc", ["%.ml"; "%.mli"]])

The default value of `~generators` is `Namespaces.builtin_generators`, which has
rules for `ocamllex` and `ocamlyacc`. See [`namespaces.mli`][mli] for details.

[mli]: https://github.com/aantron/namespaces/blob/master/src/namespaces.mli#L37
